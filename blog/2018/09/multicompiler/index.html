<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" href="/blog/2018/09/multicompiler/" />
<title>
    Optimizing for Security :: Immunant, Inc 
</title>






<link rel="stylesheet" href="/main.min.1f0ca5de9fac925dba9a1915e01d6851539e742ec145025a80fa5bab054a1299.css">



<link rel="stylesheet" type="text/css" href="/css/custom.css">



<link rel="apple-touch-icon" sizes="57x57" href="/images/favicon/apple-icon-57x57.png ">
<link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png ">
<link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png ">
<link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png ">
<link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png ">
<link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png ">
<link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png ">
<link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png ">
<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png ">
<link rel="icon" type="image/png" sizes="192x192"  href="/images/favicon/android-icon-192x192.png ">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png ">
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon/favicon-96x96.png ">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png ">
<link rel="manifest" href="/images/favicon/manifest.json ">
<meta name="msapplication-TileColor" content="#0A4F93">
<meta name="msapplication-TileImage" content="/images/favicon/ms-icon-144x144.png ">
<link rel="shortcut icon" href="/images/favicon.ico " type="image/x-icon">
<link rel="icon" href="/images/favicon.ico " type="image/x-icon">
<meta name="theme-color" content="#0A4F93"><meta itemprop="name" content="Optimizing for Security">
<meta itemprop="description" content="It is obviously very bad if everybody used the same password. It is also bad when one person reuses the same password across sites. Luckily, we have password managers that can generate unique, random passwords for each site. It is no less of a problem when everybody runs the same software for the following reason: When a software flaw is found, we want every installation of the program to be different enough that the same malicious input cannot compromise multiple users (but not so different that users notice)."><meta itemprop="datePublished" content="2018-09-10T00:00:00+00:00" />
<meta itemprop="dateModified" content="2018-09-10T00:00:00+00:00" />
<meta itemprop="wordCount" content="3295"><meta itemprop="image" content="/images"/>
<meta itemprop="keywords" content="DARPA,LLVM,Randomization," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/images"/>

<meta name="twitter:title" content="Optimizing for Security"/>
<meta name="twitter:description" content="It is obviously very bad if everybody used the same password. It is also bad when one person reuses the same password across sites. Luckily, we have password managers that can generate unique, random passwords for each site. It is no less of a problem when everybody runs the same software for the following reason: When a software flaw is found, we want every installation of the program to be different enough that the same malicious input cannot compromise multiple users (but not so different that users notice)."/>



<meta property="article:section" content="Mitigation" />

<meta property="article:published_time" content="2018-09-10 00:00:00 &#43;0000 UTC" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">Immunant</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/blog">Blog</a></li><li><a href="/contact">Contact</a></li><li><a href="/jobs">Jobs</a></li><li><a href="/migration">Migration</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>16 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title"><a href="/blog/2018/09/multicompiler/">Optimizing for Security</a></h1>
                By
                    
                    <a href="/authors/per-larsen">Per Larsen</a>
                
            

            

            <div class="post-content">
                <p>It is obviously very bad if everybody used the same password. It is also bad when one person reuses the same password across sites. Luckily, we have password managers that can <em>generate unique, random passwords</em> for each site. It is no less of a problem when everybody runs the same software for the following reason: When a software flaw is found, we want every installation of the program to be different enough that the same malicious input cannot compromise multiple users (but not so different that users notice). You don&rsquo;t use the same password as anyone else; why should you run an identical copy of the software that everybody else is running?</p>
<h2 id="the-multicompiler">The Multicompiler</h2>
<p>Compilers typically optimize for speed and size. We built a compiler that instead optimizes for security. We call it the <em>multicompiler</em> because it builds many functionally equivalent but internally different software variants, so that an exploit only works against one specific variant. The multicompiler is based on LLVM and has been tested on lots of non-trivial programs such as Firefox, Apache, Python, and even LLVM itself.</p>
<p>The multicompiler is available for download from <a href="https://github.com/securesystemslab/multicompiler">GitHub</a> right now. If you&rsquo;d like to see how to use it on real software, skip ahead to <a href="#hands-on-with-the-multicompiler">Hands On With The Multicompiler</a>.</p>
<p>The work that we&rsquo;re describing today is part of <a href="https://www.darpa.mil/program/cyber-fault-tolerant-attack-recovery">DARPAs Cyber Fault-Tolerant Attack Recovery</a> (CFAR) program. Immunant is working alongside <a href="https://galois.com/">Galois</a>, the <a href="www.uci.edu">University of California, Irvine</a>, and <a href="https://www.trailofbits.com/">Trail of Bits</a> as a team on CFAR.
We&rsquo;ll explain how our work fits into the broader CFAR effort in <a href="#cyber-fault-tolerant-attack-recovery">this</a> section. Since we a part of a larger team, we also encourage you to also read the Galois and Trail of Bits companion posts <a href="https://galois.com/blog/2018/09/protecting-applications-with-automated-software-diversity/">here</a> and <a href="https://blog.trailofbits.com/2018/09/10/protecting-software-against-exploitation-with-darpas-cfar/">here</a>.</p>
<h2 id="security-through-diversity">Security through Diversity</h2>
<p>Before computers were networked, software was distributed on physical media such as floppies and optical disks. CD-ROMs, for instance, are cloned from a golden master copy. Even when software is distributed online rather than on physical media, every user still gets an identical program copy, which is efficient but also raises a few concerns. Chief among those is the fact that vulnerable programs that are mass distributed are susceptible to exploitation on an equally massive scale. Adversaries can develop an exploit payload once and use it to exploit every identical copy.</p>
<p>Nature&rsquo;s solution to the problem is bio-diversity. A single plant might succumb to a pathogen but the entire species survives thanks to genetic variance. We don&rsquo;t accept monocultures in our crops (and when we do, <a href="https://www.wired.com/2017/03/humans-made-banana-perfect-soon-itll-gone/">disaster ensues</a>). Why then should we continue to accept monocultures in software?</p>
<p>Introducing program variance via techniques like ASLR was a start and shows the approach works. Now that we predominantly install new software over the internet, it becomes <a href="http://www.nspw.org/papers/2010/nspw2010-franz.pdf">entirely feasible</a> to give each user his or her own distinct copy of a program. The multicompiler allows us to create a diverse population of functionally identical programs that are resilient to mass exploitation.</p>
<h1 id="artificial-software-diversity">Artificial Software Diversity</h1>
<p>Typically, a compiler optimizes the output code for speed or size, and outputs different binaries by coincidence. For example, a compiler can output <em>different</em> binary code from the <em>same</em> source code simply by adjusting the optimization level from aggressive (<code>-O2</code>) to none (<code>-O0</code>). However, this method isn&rsquo;t practical because it degrades performance and only allows us to create a modest number of different binaries.</p>
<p>The multicompiler optimizes for security by introducing randomness into the compilation process. It can generate an unlimited number of program variants by randomizing decisions made during compilation. Example compilation decisions that can be easily randomized include the order in which functions are laid out in memory, and the allocation of program variables into registers. To ensure the decisions are random but repeatable, the random number generator (RNG) is seeded via a special compiler flag.
Random program binaries make it harder to for an adversary to take control of the program execution. In academic circles, this is known as <a href="http://www.ics.uci.edu/~perl/automated_software_diversity.pdf">artificial software diversity</a>. It is, of course, still possible to examine a single randomized binary to construct an exploit against it. However, the larger population will remain unaffected. With the right kind of randomization, an input that compromises variant 42 of a binary no longer compromises any other variant.</p>
<h2 id="randomize-all-the-things">Randomize all the things!</h2>
<p>From a deployment perspective, software randomization has been a spectacular success insofar that virtually any recent operating system and compiler supports Address Space Layout Randomization (ASLR). ASLR works by randomizing the base address of the stack, heap, and executable (<code>.text</code>) memory segments. While ASLR raises the difficulty of exploiting a program, it does not stop a skilled and determined adversary.</p>
<p>The multicompiler is a testbed and showcase for randomization techniques that go above and beyond the basic randomization provided by ASLR. As such, the multicompiler prioritizes security over deployability; ASLR does the exact opposite. In other words, the approaches complement each other and should be deployed together for maximum security benefit.</p>
<p>The multicompiler, which has been in development since 2010, is a set of patches and additions to the excellent clang/LLVM compiler framework. The multicompiler is well tested and works on real-world software. We have used the multicompiler to build a large number of open source packages including Firefox, Chromium, and all the packages in Linux From Scratch. In fact, we will <a href="#hands-on-with-the-multicompiler">shortly</a> show how to diversify CPython, the official Python interpreter, with the multicompiler.</p>
<p>Currently, the multicompiler supports the following transformations:</p>
<ul>
<li><strong>Code randomization</strong> to disrupt exploits that rely on specific code addresses. Code-reuse attacks execute legitimate instructions rather than injecting new ones and so, requires knowledge of the code layout to work. Aspects that the multicompiler can randomize include the function order, the allocation of variables to CPU registers, and the instruction schedule. The multicompiler can also insert extra no-op instructions and substitute one type of instruction for another instruction having the same effect.</li>
<li><strong>Stack-layout randomization</strong> interferes with attempts to corrupt stack variables. Without diversity, local variables are packed into a stack frame with each value, including the return address, residing at a well-known offset.
The multicompiler re-orders stack elements and can insert padding between stack elements or the entire stack frame. It can also randomly convert stack-allocated buffers into heap allocations and correctly deallocate them.</li>
<li><strong>Global-variable randomization</strong> interferes with attempts to overwrite global state. Normal compilers pack global variables as efficiently as possible in their own section. An overwrite past the end of one global variable can deterministically corrupt other global values. The multicompiler shuffles the order of global variables in each variant, and adds random padding to disrupt global variable overwrite attacks.</li>
</ul>
<p>The latest version of the multicompiler was just released here
<a href="https://www.github.com/securesystemslab/multicompiler">https://www.github.com/securesystemslab/multicompiler</a></p>
<h2 id="hands-on-with-the-multicompiler">Hands-on with the Multicompiler</h2>
<p>This part is intended to provide those of you who learn by doing a chance to try the multicompiler for yourself. We&rsquo;ll be following a simplified set of build steps here; the complete process is described in the multicompiler <a href="https://github.com/securesystemslab/multicompiler/blob/master/README.md">README</a>. Some advanced features not covered here will not be available or function correctly unless you follow the complete build process.</p>
<p>What we&rsquo;ll cover:</p>
<ol>
<li>preparing to build the Multicompiler</li>
<li>checking that the system linker can support link-time optimization</li>
<li>building the multicompiler</li>
<li>diversifying CPython with the multicompiler</li>
<li>testing and inspecting differences between variants</li>
</ol>
<h3 id="downloading-dependencies-and-sources">Downloading Dependencies and Sources</h3>
<p>This section assumes you have root access to a host running Ubuntu 16.04 or later. If you&rsquo;re on another Linux distribution, you&rsquo;ll need to adjust the commands accordingly. If you&rsquo;re on Windows or macOS, you can use docker or VirtualBox to set up a suitable Linux environment.</p>
<pre><code class="language-bash"># install prerequisite packages on Ubuntu as root
# note: the default version of cmake on Ubuntu 14.04 is too old for LLVM.
apt-get install -y  \
	build-essential libssl-dev libxml2-dev \
	libpcre3-dev binutils-dev cmake git mdm
</code></pre>
<pre><code class="language-bash">ROOT_DIR=$HOME/diversity &amp;&amp; mkdir -p $ROOT_DIR &amp;&amp; cd $ROOT_DIR

git clone --depth 1 \
	git@github.com:securesystemslab/multicompiler.git \
	multicompiler

git clone --depth 1 \
	git@github.com:securesystemslab/multicompiler-clang.git \
	multicompiler/tools/clang

git clone --depth 1 \
	git@github.com:securesystemslab/multicompiler-compiler-rt.git \
	multicompiler/projects/compiler-rt

git clone --depth 1 \
	git@github.com:securesystemslab/poolalloc.git \
	multicompiler/projects/poolalloc
</code></pre>
<h3 id="linker-plugin-support">Linker Plugin Support</h3>
<pre><code class="language-bash">$ /usr/bin/ld -plugin
/usr/bin/ld: -plugin: missing argument
/usr/bin/ld: use the --help option for usage information
</code></pre>
<p>If you see <code>-plugin: missing argument</code> in the output, you&rsquo;re all set. Otherwise you can build your own copy of binutils with plugin support using <a href="https://llvm.org/docs/GoldPlugin.html#how-to-build-it">these instructions</a>. You&rsquo;ll need to adjust the path to point to your custom binutils build in the next step.</p>
<h3 id="configuring-and-making">Configuring and Making</h3>
<pre><code class="language-bash"># building multicompiler in-tree isn't recommended
BUILD_DIR=$ROOT_DIR/multicompiler/build &amp;&amp; mkdir -p $BUILD_DIR &amp;&amp; cd $BUILD_DIR

# `DLLVM_BINUTILS_INCDIR` is required for LTO support. If your host linker
# was built without plugin support, point `LLVM_BINUTILS_INCDIR` to the
# path of the binutils binaries you built previously.
cmake .. -DLLVM_TARGETS_TO_BUILD=&quot;X86&quot; \
 	-DCMAKE_INSTALL_PREFIX=$ROOT_DIR/multicompiler/install \
	-DLLVM_BINUTILS_INCDIR=/usr/include \
	-DCMAKE_BUILD_TYPE=Release

make -j`ncpus` &amp;&amp; make install
</code></pre>
<h3 id="downloading-cpython-sources">Downloading CPython Sources</h3>
<p>We&rsquo;re almost ready to use the multicompiler, all we need is to download the CPython source code and its build dependencies.</p>
<pre><code class="language-bash"># dependencies
apt-get install --no-install-recommends -y \
	python-setuptools tcl-dev liblzma-dev libgdbm-dev tk-dev libreadline-dev

# sources
PY2_SRC=https://www.python.org/ftp/python/2.7.12/Python-2.7.12.tgz

cd $ROOT_DIR &amp;&amp; wget $PY2_SRC -O - | tar -zx
</code></pre>
<h3 id="diversifying-cpython-with-the-multicompiler">Diversifying CPython with the Multicompiler</h3>
<p>Kudos for making it thus far, let&rsquo;s compile our own diversified CPython binary!</p>
<p>There is no particular reason that we chose CPython2 other than the fact that it comes with a comprehensive test suite and has a relatively sane build system. We&rsquo;re using the <code>CC</code> and <code>CXX</code> environment variables to point the build system to the multicompiler you just built. We&rsquo;re also passing the <code>-flto</code> flag to make sure we always compile in link-time optimization mode. We&rsquo;re going to compile CPython twice: once without diversity (<code>norando</code>), once with function order randomization (<code>fnrando</code>). It is usually desirable to apply multiple types of diversity to a single build; try enabling additional randomization flags. All the flags accepted by the multicompiler are described in the <a href="https://github.com/securesystemslab/multicompiler/blob/master/README.md">README</a>.</p>
<p>Note that you may have to change the ways flags are passed to the compiler if you decide to compile and diversify some other software package.</p>
<pre><code class="language-bash"># configuring and making a link-time-optimized CPython binary
cd $ROOT_DIR/Python-2.7.12
CC=&quot;$ROOT_DIR/multicompiler/install/bin/clang -flto&quot; \
CXX=&quot;$ROOT_DIR/multicompiler/install/bin/clang++ -flto&quot; \
RANLIB=&quot;$ROOT_DIR/multicompiler/install/bin/llvm-ranlib&quot; \
AR=&quot;$ROOT_DIR/multicompiler/install/bin/llvm-ar&quot; \
CFLAGS=&quot;-O2 -g -frandom-seed=42&quot; \
CXXFLAGS=$CFLAGS \
LDFLAGS=&quot;-Wl,--plugin-opt,-random-seed=42&quot; \
	./configure --prefix=$ROOT_DIR/python_norando &amp;&amp; make -j`ncpus` install

#  testing (excluding tests that can fail on Ubuntu hosts)
time make TESTOPTS=&quot;-x test_gdb test_ssl&quot; quicktest

make distclean

# configuring and making a link-time-diversified CPython binary
# by adding `-randomize-function-list` to `LDFLAGS`
CC=&quot;$ROOT_DIR/multicompiler/install/bin/clang -flto&quot; \
CXX=&quot;$ROOT_DIR/multicompiler/install/bin/clang++ -flto&quot; \
RANLIB=&quot;$ROOT_DIR/multicompiler/install/bin/llvm-ranlib&quot; \
AR=&quot;$ROOT_DIR/multicompiler/install/bin/llvm-ar&quot; \
CFLAGS=&quot;-O2 -g -frandom-seed=42&quot; \
CXXFLAGS=$CFLAGS \
LDFLAGS=&quot;-Wl,--plugin-opt,-random-seed=42 -Wl,--plugin-opt,-randomize-function-list&quot; \
	./configure --prefix=$ROOT_DIR/python_fnrando &amp;&amp; make -j`ncpus` install

#  testing diversified python
time make TESTOPTS=&quot;-x test_gdb test_ssl&quot; quicktest
</code></pre>
<p><strong>Note:</strong> we pass a random seed even for the &ldquo;norando&rdquo; build (where none is required) to suppress warnings.</p>
<h3 id="verifying-the-effects-of-function-randomization">Verifying the Effects of Function Randomization</h3>
<pre><code class="language-bash">nm --numeric-sort $ROOT_DIR/python_norando/bin/python | \
	egrep &quot;[[:xdigit:]]+\st\s\w+&quot; | tail

nm --numeric-sort $ROOT_DIR/python_fnrando/bin/python | \
	egrep &quot;[[:xdigit:]]+\st\s\w+&quot; | tail

</code></pre>
<p>On the host used for testing, <code>tail</code> returns the following for <code>python_norando</code></p>
<pre><code class="language-plain">0000000000559160 t ast_for_call
0000000000559910 t ast_for_slice
0000000000559d40 t alias_for_import_name
000000000055a280 t ast_for_suite
000000000055a520 t ast_for_funcdef
000000000055a6c0 t ast_for_classdef
00000000007a2dd0 t __frame_dummy_init_array_entry
00000000007a2dd0 t __init_array_start
00000000007a2dd8 t __do_global_dtors_aux_fini_array_entry
00000000007a2dd8 t __init_array_end
</code></pre>
<p>whereas the same command for <code>python_fnrando</code> prints</p>
<pre><code class="language-plain">000000000055bea0 t iter_len
000000000055bfd0 t slot_nb_inplace_and
000000000055bff0 t wrap_ternaryfunc_r
000000000055c060 t formatteriter_next
000000000055c270 t frame_get_f_exc_value
000000000055c310 t builtin_repr
00000000007a2dd0 t __frame_dummy_init_array_entry
00000000007a2dd0 t __init_array_start
00000000007a2dd8 t __do_global_dtors_aux_fini_array_entry
00000000007a2dd8 t __init_array_end
</code></pre>
<p>The last four functions have not been shuffled by the multicompiler. This is because these functions originate from precompiled files (e.g. <code>crtbegin.o</code>) on the host and were linked in automatically. In other words, precompiled code in objects or libraries is not visible to the multicompiler. For maximal security coverage, all code must pass through the multicompiler.</p>
<p><strong>Note:</strong> The way we&rsquo;ve built CPython is simple but not the most secure. To show what arguments were passed to the CPython <code>configure</code> script on your host, run the following commands in a python REPL:</p>
<pre><code class="language-python">import distutils.sysconfig
print(distutils.sysconfig.get_config_var('CONFIG_ARGS'))
</code></pre>
<p>Example output on Ubuntu 16.04:</p>
<pre><code class="language-bash">'--enable-shared' '--prefix=/usr' '--enable-ipv6' '--enable-unicode=ucs4' 
'--with-dbmliborder=bdb:gdbm' '--with-system-expat' '--with-computed-gotos' 
'--with-system-ffi'  '--with-fpectl' 'CC=x86_64-linux-gnu-gcc' 
'CFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2 -g  -fstack-protector-strong -Wformat 
-Werror=format-security ' 'LDFLAGS=-Wl,-Bsymbolic-functions -Wl,-z,relro'
</code></pre>
<h3 id="performance-impact-of-randomization">Performance Impact of Randomization</h3>
<p>Now that we&rsquo;ve checked that functions are getting shuffled around as expected, lets see what kind of performance impact this transformation is having. In general, the overheads you&rsquo;ll see depends on what transformations were enabled and the workload itself. Function shuffling tends to have very low overhead (e.g., less than 1% on the <a href="https://www.spec.org/cpu2006/CINT2006/">SPEC CINT2006</a> benchmarks) which is not all that surprising; the layout of functions shouldn&rsquo;t really matter given the large number of caching mechanisms used in modern processors.</p>
<p>On an unloaded Ubuntu 16.04 host, the <code>norando</code> and <code>fnrando</code> runs of the testsuite finished in 4m48s and 4m51s respectively. Re-running the testsuite shows that much of the difference we observe is due to measurement noise. The performance overhead added by randomization depends on what is being randomized as well as the underlying program and workload. Function layout randomization tends to add non-negligible overheads whereas others can add 5 to 10% in cases to CPU-bound workloads.</p>
<h2 id="cyber-fault-tolerant-attack-recovery">Cyber Fault-Tolerant Attack Recovery</h2>
<p>Since mid-2015, we&rsquo;ve been working to test and enhance the multicompiler as part of a DARPAs <a href="https://www.darpa.mil/program/cyber-fault-tolerant-attack-recovery">Cyber Fault-Tolerant Attack Recovery (CFAR)</a> program. While the multicompiler already produces binaries that are more resilient thanks to randomization, running two or more randomized programs (variants) alongside each other provides additional security. According to the CFAR program goals:</p>
<blockquote>
<p>Fault-tolerant architectures run multiple subsystems in parallel and constantly cross-check results to rapidly detect, isolate and mitigate faults, which manifest as differences across the subsystems. Adapting fault-tolerant systems to run multiple variants of a vulnerable software system in parallel presents the opportunity to immediately detect and interdict cyber-attacks before they gain a foothold.</p>
</blockquote>
<p>This description is a bit terse, so let&rsquo;s unpack it.</p>
<p>To run multiple program variants in parallel, we use a type of monitoring software (called a multi-variant execution environment, MVEE) to make sure that all variants receive the same inputs and that all variants generate the same output. If the MVEE sees that the variants starts to diverge in their behavior, it shuts them down since the divergence might be a symptom of compromise.</p>
<p>Thanks to variant monitoring, MVEEs stop low-level exploits and contain the effects of a compromised program variant. An exploit can either compromise a single variant, which will cause its execution to diverge from other executing variants in which case the MVEE will terminate execution. Alternatively, an exploit can compromise all program variants and avoid any observable differences. Doing the latter is very difficult-especially when the diversified variants are substantially different. For instance, a regular code-reuse exploit becomes impossible if the address ranges for the <code>.text</code> sections of two program variants are disjoint. You can read much more about this idea in this paper <a href="http://www.ics.uci.edu/~stijnv/Papers/tdsc15-gadgets.pdf">Cloning your Gadgets: Complete ROP Attack Immunity with Multi-Variant Execution</a> written by a fellow CFAR researcher at UCI <a href="https://stijn-volckaert.github.io/personal/">Stijn Volckaert</a>.</p>
<p>CFAR, like other DARPA programs, involves several teams. Immunant is part of a team led by Galois, Inc. that also includes UC Irvine and Trail of Bits (ToB). ToB provides a binary lifting tool, McSema, which converts binary programs to LLVM&rsquo;s intermediate representation, bitcode. The bitcode recovered by McSema is not identical to the bitcode one would get by parsing the program source code but is rich enough that it can be fed into the multicompiler and diversified. Immunant works alongside UCI to enhance the multicompiler, and Galois integrates, tests, and carefully analyses the products of all these tools and libraries. The output of this process is a <em>variant set</em> in CFAR parlance. The variant set is a set of diversified program variants randomized using a set of options chosen to minimize the probability that a single exploit can compromise each individual variant when run in an MVEE. In many instances, Galois is able to provide formal guarantees that a given exploit cannot be constructed against the set. This is a great example of how redundancy lets us construct a whole that is more secure and resilient than any of its constituent parts.</p>
<h2 id="want-to-learn-more">Want to learn more?</h2>
<p>There&rsquo;s much more to be said about software randomization. Here&rsquo;s a few suggested papers if you want to know more.</p>
<h3 id="software-diversity">Software Diversity</h3>
<p><a href="http://dx.doi.org/10.1109/TDSC.2015.2433252">Large-scale Automated Software Diversity-Program Evolution Redux</a> provides an in-depth description of the multicompiler and evaluates several of its most mature transformations.</p>
<p><a href="http://www.ics.uci.edu/~perl/automated_software_diversity.pdf">SoK: Automated Software Diversity</a> gives a survey of all the different kinds of randomization researchers have proposed and tried out until circa 2014.</p>
<p><a href="https://www.ics.uci.edu/~perl/pets16_selfrando.pdf">Selfrando: Securing the Tor Browser against De-anonymization Exploits</a> describes a load-time code randomizer that we built. Selfrando is focused on deployability and, unlike the multicompiler, works with existing compilers and linkers out of the box. In fact, it is practical enough that it is being tested in nightly builds of the Tor Browser for Linux. Selfrando is free and open source. Grab a copy from <a href="https://github.com/immunant/selfrando">https://github.com/immunant/selfrando</a> and try it out for yourself.</p>
<p><a href="http://www.ics.uci.edu/~perl/sd16_pagerando.pdf">Code Randomization: Haven&rsquo;t We Solved This Problem Yet?</a> addresses the problem of randomizing shared libraries <em>without</em> interfering with memory sharing for code pages. Most academic work overlooked the fact that nobody is going to deploy diversity techniques if they cause working sets to spike.</p>
<p><a href="http://www.ics.uci.edu/~perl/oakland15_readactor.pdf">Readactor: Practical Code Randomization Resilient to Memory Disclosure</a> addresses the problem of keeping the randomized code layout secret. Randomization is no good if the adversary can use clever tricks (e.g. <a href="https://cs.unc.edu/~fabian/papers/oakland2013.pdf">JIT-ROP</a>) to dynamically read the code after randomization. Readactor explores execute-only memory for modern x86 systems and also prevents pointers into code from <em>indirectly</em> revealing the code layout.</p>
<h3 id="multi-variant-execution-environments">Multi-variant Execution Environments</h3>
<p><a href="http://www.ics.uci.edu/~stijnv/Papers/tdsc15-gadgets.pdf">Cloning your Gadgets: Complete ROP Attack Immunity with Multi-Variant Execution</a> explores the idea of loading the code pages of variants into disjoint address ranges.</p>
<p><a href="http://www.ics.uci.edu/~stijnv/Papers/atc16-remon.pdf">ReMon ATC'2016 Paper</a> describes a fast-yet-secure MVEE design, ReMon, which is faster because part of the monitoring is done inside the process that runs the program variants.</p>
<p><a href="https://github.com/stijn-volckaert/ReMon">ReMon MVEE GitHub repository</a> ReMon is open source and actively maintained during the CFAR program. Download it and try it out for yourself.</p>
<h2 id="conclusions">Conclusions</h2>
<p>Artificial software diversity can improve application security by preventing adversaries from making assumptions about the code and data layout and other offensively useful features of the victim program. Randomization does not make binaries impervious to exploitation on their own but complements and pairs well with other low-level exploit mitigations such as control-flow integrity.</p>
<p>Where even higher levels of resilience are sought, diversified programs can run side by side in an MVEE and continually monitored for signs that the system is under attack. Galois has a detailed writeup on their <a href="https://galois.com/blog/2018/09/protecting-applications-with-automated-software-diversity/">blog</a> and covers important caveats in this <a href="https://galois.com/blog/2018/09/automated-software-diversity-sometimes-more-isnt-merrier/">followup post</a>.</p>
<p>Although we&rsquo;ve focused on compiling from source, it is also possible to randomize source-less binaries. Trail of Bits explains how to diversify binaries with the multicompiler in their <a href="https://blog.trailofbits.com/2018/09/10/protecting-software-against-exploitation-with-darpas-cfar/">excellent companion post</a>.</p>
<h3 id="about-immunant">About Immunant</h3>
<p>Immunant is a spin-off from UC Irvine and specializes in compiler-based exploit mitigation and <a href="https://www.c2rust.com">language migration</a>. We&rsquo;re located in Southern California. If you&rsquo;re interested in practical systems security, we&rsquo;d love hear from you; reach us at <code>team@immunant.com</code>, <code>@immunant</code>, or via our <a href="https://immunant.com/contact">contact form</a>.</p>
<p>Besides the multicompiler, which is the focus of this post, we&rsquo;ve also built a slightly different randomizer called <a href="https://www.github.com/immunant/selfrando">selfrando</a>. Selfrando is  <a href="https://blog.torproject.org/selfrando-q-and-georg-koppen">included</a> in the Experimental Tor Browser for Linux. We hope to help shield Tor users from certain kinds of zero-day attacks and monitoring. One of the advantages of selfrando over the multicompiler is that it works with your existing compiler and linker on Windows, Android, and Linux.</p>
<h3 id="acknowledgements-and-disclaimer">Acknowledgements and Disclaimer</h3>
<p>This material is based upon work supported by the United States Air Force and DARPA under Contract No. FA8750–15-C–0124.</p>
<p>We thank everyone who directly helped develop the multicompiler and all the people who provided helpful feedback. The views, opinions and/or findings expressed are those of the author and should not be interpreted as representing the official views or policies of the Department of Defense or the U.S. Government.</p>
<p>Distribution Statement “A” (Approved for Public Release, Distribution Unlimited).</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="/tags/darpa">DARPA</a></span><span class="tag"><a href="/tags/llvm">LLVM</a></span><span class="tag"><a href="/tags/randomization">Randomization</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>3295 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2018-09-09 17:00 -0700</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="/blog/2019/08/introduction-to-c2rust/">
                                <span class="button__icon">←</span>
                                <span class="button__text">Introduction to C2Rust</span>
                            </a>
                        </span>
                    

                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2022</span>
            
            <span>Immunant, Inc.</span>
            <span>
                <div>
                    &nbsp; <a href="https://github.com/immunant" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a> &nbsp;&nbsp; <a href="https://twitter.com/immunant" target="_blank" rel="noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a> &nbsp;&nbsp; <a href="mailto:team@immunant.com" target="_blank" rel="noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a> &nbsp;&nbsp; <a href="https://www.linkedin.com/company/immunant/" target="_blank" rel="noopener" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a> &nbsp;
                </div>
            </span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.123de7cc230820e3909ccb5370ba6522c6048b15e8bf14ea28cf3c96fb4ac908f5e41ef24aa6518a3ca6484f933bf36bdd1aca7fd4f14de131a69d89e7525ce6.js" integrity="sha512-Ej3nzCMIIOOQnMtTcLplIsYEixXovxTqKM88lvtKyQj15B7ySqZRijymSE&#43;TO/Nr3RrKf9TxTeExpp2J51Jc5g=="></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-44066564-2', 'auto');
        ga('send', 'pageview');
    </script>


	
		<script src="/js/prism_custom.js"></script>
	


    </body>
</html>
